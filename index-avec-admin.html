<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        h2 { color: #333; font-size: 1.5em; margin-bottom: 20px; }
        h3 { color: #667eea; margin-bottom: 15px; }
        
        .subtitle { color: #666; font-size: 1.1em; margin-bottom: 30px; }
        .question { margin-bottom: 30px; }
        .question h2 { color: #333; font-size: 1.5em; margin-bottom: 20px; }
        
        .options { display: flex; flex-direction: column; gap: 10px; }
        
        .option {
            padding: 15px 20px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .option:hover { background: #e3f2fd; border-color: #667eea; }
        .option.selected { background: #667eea; color: white; border-color: #667eea; }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .button:hover { background: #5568d3; transform: translateY(-2px); }
        .button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .button-small { padding: 8px 16px; font-size: 0.9em; margin: 5px; }
        .button-danger { background: #dc3545; }
        .button-danger:hover { background: #c82333; }
        .button-success { background: #28a745; }
        .button-success:hover { background: #218838; }
        
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill { height: 100%; background: #667eea; transition: width 0.3s; }
        .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .back-button { background: #999; }
        .back-button:hover { background: #777; }
        
        textarea, input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        textarea { resize: vertical; min-height: 100px; }
        textarea:focus, input:focus, select:focus { outline: none; border-color: #667eea; }
        
        .success-message { text-align: center; padding: 60px 20px; }
        .success-message h2 { color: #667eea; font-size: 2.5em; margin-bottom: 20px; }
        
        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .hidden { display: none; }
        
        .admin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
        }
        
        .admin-link:hover { background: rgba(0,0,0,0.9); }
        
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .admin-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
        }
        
        .admin-tab:hover { color: #667eea; }
        .admin-tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: bold; }
        
        .question-editor {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }
        
        .option-input { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .option-input input { flex: 1; margin-bottom: 0; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-label { font-size: 0.9em; opacity: 0.9; margin-bottom: 5px; }
        .stat-value { font-size: 2.5em; font-weight: bold; }
        
        .chart-section { margin-bottom: 30px; }
        .chart-bar { margin-bottom: 15px; }
        .chart-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .bar-container { height: 30px; background: #f0f0f0; border-radius: 5px; overflow: hidden; }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- USER VIEW -->
        <div id="userView">
            <div id="intro">
                <h1>üìã Questionnaire</h1>
                <p class="subtitle">Merci de prendre quelques minutes pour r√©pondre √† ce questionnaire. Vos r√©ponses sont anonymes.</p>
                <button class="button" onclick="startSurvey()">Commencer</button>
            </div>
            
            <div id="surveyQuestions" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <p id="progressText" style="color: #666; margin-bottom: 20px;">Question 1 sur 8</p>
                <div id="questionContainer"></div>
                <div class="nav-buttons">
                    <button class="button back-button" id="prevBtn" onclick="previousQuestion()" style="display:none">‚Üê Pr√©c√©dent</button>
                    <button class="button" id="nextBtn" onclick="nextQuestion()" disabled>Suivant ‚Üí</button>
                </div>
            </div>
            
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Envoi de vos r√©ponses...</p>
            </div>
            
            <div id="thankYou" class="hidden">
                <div class="success-message">
                    <h2>‚úÖ Merci !</h2>
                    <p class="subtitle">Votre participation a bien √©t√© enregistr√©e.</p>
                </div>
            </div>
            
            <div id="errorView" class="hidden">
                <div class="error-message">
                    <h3>‚ö†Ô∏è Erreur</h3>
                    <p id="errorMessage">Une erreur est survenue.</p>
                </div>
                <button class="button" onclick="location.reload()">R√©essayer</button>
            </div>
        </div>
        
        <!-- ADMIN LOGIN -->
        <div id="adminLogin" class="hidden">
            <h1>üîê Acc√®s Admin</h1>
            <p class="subtitle">Connectez-vous pour acc√©der au dashboard</p>
            <input type="password" id="adminPassword" placeholder="Mot de passe" onkeypress="if(event.key==='Enter') adminLogin()">
            <button class="button" onclick="adminLogin()" style="width: 100%;">Se connecter</button>
            <p id="loginError" class="error-message" style="display: none;">Mot de passe incorrect</p>
            <button class="button back-button" onclick="showMainView()" style="width: 100%; margin-top: 10px;">‚Üê Retour</button>
        </div>
        
        <!-- ADMIN DASHBOARD -->
        <div id="adminDashboard" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1>üë®‚Äçüíº Dashboard Admin</h1>
                <button class="button back-button" onclick="logout()">D√©connexion</button>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('stats')">üìä Statistiques</button>
                <button class="admin-tab" onclick="showAdminTab('questions')">‚úèÔ∏è Questions</button>
                <button class="admin-tab" onclick="showAdminTab('config')">‚öôÔ∏è Configuration</button>
            </div>
            
            <!-- Stats Tab -->
            <div id="adminStats" class="admin-content">
                <div style="margin-bottom: 20px;">
                    <button class="button button-success button-small" onclick="refreshStats()">üîÑ Actualiser</button>
                    <button class="button button-small" onclick="exportCSV()">üì• Exporter CSV</button>
                </div>
                <p class="subtitle" id="statsCount">Aucune r√©ponse</p>
                <div class="stats-grid" id="statsGrid"></div>
                <div id="chartsContainer"></div>
            </div>
            
            <!-- Questions Tab -->
            <div id="adminQuestions" class="admin-content hidden">
                <button class="button button-success" onclick="addQuestion()">‚ûï Ajouter une question</button>
                <div id="questionsEditor" style="margin-top: 20px;"></div>
                <button class="button" onclick="saveQuestions()" style="width: 100%; margin-top: 20px;">üíæ Sauvegarder les questions</button>
            </div>
            
            <!-- Config Tab -->
            <div id="adminConfig" class="admin-content hidden">
                <h3>Configuration Google Sheets</h3>
                <label>URL du script Google Apps :</label>
                <input type="text" id="googleScriptUrl" value="">
                <button class="button" onclick="saveConfig()">üíæ Sauvegarder</button>
                
                <h3 style="margin-top: 30px;">Mot de passe Admin</h3>
                <input type="password" id="newPassword" placeholder="Nouveau mot de passe">
                <button class="button" onclick="changePassword()">üîí Changer le mot de passe</button>
                
                <h3 style="margin-top: 30px;">‚ö†Ô∏è Zone de danger</h3>
                <button class="button button-danger" onclick="clearAllData()">üóëÔ∏è Effacer toutes les donn√©es</button>
            </div>
        </div>
    </div>
    
    <button class="admin-link" onclick="showAdminLogin()">üîê Admin</button>

    <script>
        // Configuration
        const ADMIN_PASSWORD_KEY = 'admin_password';
        const GOOGLE_URL_KEY = 'google_script_url';
        const QUESTIONS_KEY = 'survey_questions';
        const RESPONSES_KEY = 'survey_responses';
        
        // Initialisation
        let adminPassword = localStorage.getItem(ADMIN_PASSWORD_KEY) || 'admin123';
        let GOOGLE_SCRIPT_URL = localStorage.getItem(GOOGLE_URL_KEY) || 'https://script.google.com/macros/s/AKfycbzfdLjPqSx6a1aoOWA-cQsZ2GOTqQlMu2oF5zC3FyGYgehr2FVnQQyieoGqwpwwAIoz/exec';
        
        let questions = [
            { id: 'interest', question: 'Seriez-vous int√©ress√©(e) par un service qui g√®re tous vos besoins de locataire ?', type: 'scale', options: ['Pas du tout', 'Peu int√©ress√©', 'Int√©ress√©', 'Tr√®s int√©ress√©', 'Absolument !'] },
            { id: 'age', question: 'Quelle est votre tranche d\'√¢ge ?', type: 'single', options: ['18-24 ans', '25-34 ans', '35-44 ans', '45-54 ans', '55+ ans'] },
            { id: 'status', question: 'Quel est votre statut actuel ?', type: 'single', options: ['√âtudiant(e)', 'Salari√©(e)', 'Ind√©pendant(e)', 'Demandeur d\'emploi', 'Autre'] },
            { id: 'rental', question: '√ätes-vous actuellement locataire ?', type: 'single', options: ['Oui, locataire', 'Non, propri√©taire', 'En recherche', 'H√©berg√©(e)'] },
            { id: 'pain', question: 'Principale difficult√© rencontr√©e en tant que locataire ?', type: 'single', options: ['Comprendre mon bail', 'D√©marches administratives', 'Probl√®mes propri√©taire', 'R√©cup√©ration caution', 'Trouver meilleurs contrats', 'Autre'] },
            { id: 'feature', question: 'Fonctionnalit√© qui vous int√©resserait le plus ?', type: 'single', options: ['Analyse IA du bail', 'Assistance juridique', 'Optimisation contrats', 'Gestion APL', 'Suivi caution', 'Paiement loyer auto'] },
            { id: 'pricing', question: 'Combien seriez-vous pr√™t(e) √† payer mensuellement ?', type: 'single', options: ['Gratuit uniquement', '5-10‚Ç¨/mois', '10-20‚Ç¨/mois', '20-30‚Ç¨/mois', '30‚Ç¨+/mois'] },
            { id: 'feedback', question: 'Des suggestions ou remarques ? (optionnel)', type: 'text', options: [] }
        ];
        
        const savedQuestions = localStorage.getItem(QUESTIONS_KEY);
        if (savedQuestions) questions = JSON.parse(savedQuestions);
        
        let currentQ = 0;
        let answers = {};
        let responses = JSON.parse(localStorage.getItem(RESPONSES_KEY) || '[]');
        
        // Navigation
        function showMainView() {
            document.getElementById('userView').classList.remove('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('intro').classList.remove('hidden');
            document.getElementById('surveyQuestions').classList.add('hidden');
            document.getElementById('thankYou').classList.add('hidden');
        }
        
        function showAdminLogin() {
            document.getElementById('userView').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }
        
        function showAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById('admin' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            if (tab === 'stats') refreshStats();
            if (tab === 'questions') renderQuestionsEditor();
            if (tab === 'config') document.getElementById('googleScriptUrl').value = GOOGLE_SCRIPT_URL;
        }
        
        // User Survey
        function startSurvey() {
            currentQ = 0;
            answers = {};
            document.getElementById('intro').classList.add('hidden');
            document.getElementById('surveyQuestions').classList.remove('hidden');
            renderQuestion();
        }
        
        function renderQuestion() {
            const q = questions[currentQ];
            const container = document.getElementById('questionContainer');
            const progress = ((currentQ + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `Question ${currentQ + 1} sur ${questions.length}`;
            let html = `<div class="question"><h2>${q.question}</h2>`;
            if (q.type === 'text') {
                html += `<textarea id="answer" placeholder="Votre r√©ponse...">${answers[q.id] || ''}</textarea>`;
            } else {
                html += '<div class="options">';
                q.options.forEach((opt, idx) => {
                    const selected = answers[q.id] === (q.type === 'scale' ? idx : opt) ? 'selected' : '';
                    const value = q.type === 'scale' ? idx : opt;
                    html += `<div class="option ${selected}" onclick="selectAnswer('${q.id}', ${JSON.stringify(value).replace(/"/g, '&quot;')})">${opt}</div>`;
                });
                html += '</div>';
            }
            html += '</div>';
            container.innerHTML = html;
            document.getElementById('prevBtn').style.display = currentQ > 0 ? 'block' : 'none';
            document.getElementById('nextBtn').textContent = currentQ === questions.length - 1 ? '‚úì Terminer' : 'Suivant ‚Üí';
            updateNextButton();
        }
        
        function selectAnswer(id, value) {
            answers[id] = value;
            renderQuestion();
        }
        
        function updateNextButton() {
            const q = questions[currentQ];
            const hasAnswer = q.type === 'text' || answers[q.id] !== undefined;
            document.getElementById('nextBtn').disabled = !hasAnswer && q.type !== 'text';
        }
        
        function nextQuestion() {
            const q = questions[currentQ];
            if (q.type === 'text') {
                const textarea = document.getElementById('answer');
                if (textarea) answers[q.id] = textarea.value;
            }
            if (currentQ < questions.length - 1) {
                currentQ++;
                renderQuestion();
            } else {
                submitSurvey();
            }
        }
        
        function previousQuestion() {
            if (currentQ > 0) {
                currentQ--;
                renderQuestion();
            }
        }
        
        async function submitSurvey() {
            document.getElementById('surveyQuestions').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            const data = { timestamp: new Date().toISOString(), ...answers };
            questions.forEach(q => {
                if (q.type === 'scale' && typeof data[q.id] === 'number') {
                    data[q.id] = q.options[data[q.id]];
                }
            });
            responses.push(data);
            localStorage.setItem(RESPONSES_KEY, JSON.stringify(responses));
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                console.error('Erreur Google Sheets:', error);
            }
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('thankYou').classList.remove('hidden');
            }, 1000);
        }
        
        // Admin
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === adminPassword) {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('adminPassword').value = '';
                refreshStats();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function logout() {
            showMainView();
        }
        
        function refreshStats() {
            if (responses.length === 0) {
                document.getElementById('statsCount').textContent = 'Aucune r√©ponse';
                document.getElementById('statsGrid').innerHTML = '';
                document.getElementById('chartsContainer').innerHTML = '<p>Collectez des r√©ponses pour voir les statistiques</p>';
                return;
            }
            const total = responses.length;
            document.getElementById('statsCount').textContent = `${total} r√©ponse${total > 1 ? 's' : ''} collect√©e${total > 1 ? 's' : ''}`;
            let statsHtml = `<div class="stat-card"><div class="stat-label">R√©ponses totales</div><div class="stat-value">${total}</div></div>`;
            const interestQ = questions.find(q => q.id === 'interest');
            if (interestQ) {
                const avgInterest = responses.reduce((sum, r) => sum + (typeof r.interest === 'number' ? r.interest : 0), 0) / total;
                const highInterest = responses.filter(r => (r.interest || 0) >= 3).length;
                const conversionRate = ((highInterest / total) * 100).toFixed(0);
                statsHtml += `<div class="stat-card"><div class="stat-label">Taux d'int√©r√™t</div><div class="stat-value">${conversionRate}%</div></div>`;
                statsHtml += `<div class="stat-card"><div class="stat-label">Score moyen</div><div class="stat-value">${avgInterest.toFixed(1)}/4</div></div>`;
            }
            document.getElementById('statsGrid').innerHTML = statsHtml;
            let chartsHtml = '';
            questions.forEach(q => {
                if (q.type === 'text') return;
                const data = {};
                responses.forEach(r => {
                    let answer = r[q.id];
                    if (q.type === 'scale' && typeof answer === 'number') answer = q.options[answer] || 'Non renseign√©';
                    answer = answer || 'Non renseign√©';
                    data[answer] = (data[answer] || 0) + 1;
                });
                chartsHtml += `<div class="chart-section"><h3>${q.question}</h3>`;
                Object.entries(data).sort((a, b) => b[1] - a[1]).forEach(([answer, count]) => {
                    const percent = (count / total * 100).toFixed(0);
                    chartsHtml += `<div class="chart-bar"><div class="chart-label"><span>${answer}</span><span><strong>${count}</strong> (${percent}%)</span></div><div class="bar-container"><div class="bar-fill" style="width: ${percent}%">${percent}%</div></div></div>`;
                });
                chartsHtml += '</div>';
            });
            document.getElementById('chartsContainer').innerHTML = chartsHtml;
        }
        
        function renderQuestionsEditor() {
            let html = '';
            questions.forEach((q, idx) => {
                html += `<div class="question-editor"><strong>Question ${idx + 1}</strong><input type="text" value="${q.question}" onchange="questions[${idx}].question = this.value"><select onchange="questions[${idx}].type = this.value; renderQuestionsEditor();"><option value="single" ${q.type === 'single' ? 'selected' : ''}>Choix unique</option><option value="scale" ${q.type === 'scale' ? 'selected' : ''}>√âchelle</option><option value="text" ${q.type === 'text' ? 'selected' : ''}>Texte libre</option></select>`;
                if (q.type !== 'text') {
                    html += '<div style="margin-top: 10px;"><strong>Options:</strong>';
                    q.options.forEach((opt, optIdx) => {
                        html += `<div class="option-input"><input type="text" value="${opt}" onchange="questions[${idx}].options[${optIdx}] = this.value"><button class="button button-danger button-small" onclick="questions[${idx}].options.splice(${optIdx}, 1); renderQuestionsEditor();">‚úï</button></div>`;
                    });
                    html += `<button class="button button-success button-small" onclick="questions[${idx}].options.push('Nouvelle option'); renderQuestionsEditor();">+ Ajouter option</button></div>`;
                }
                html += `<button class="button button-danger button-small" onclick="deleteQuestion(${idx})">üóëÔ∏è Supprimer</button></div>`;
            });
            document.getElementById('questionsEditor').innerHTML = html;
        }
        
        function addQuestion() {
            questions.push({ id: 'q' + Date.now(), question: 'Nouvelle question', type: 'single', options: ['Option 1', 'Option 2'] });
            renderQuestionsEditor();
        }
        
        function deleteQuestion(idx) {
            if (confirm('Supprimer cette question ?')) {
                questions.splice(idx, 1);
                renderQuestionsEditor();
            }
        }
        
        function saveQuestions() {
            localStorage.setItem(QUESTIONS_KEY, JSON.stringify(questions));
            alert('‚úÖ Questions sauvegard√©es ! Rechargez la page pour voir les changements.');
        }
        
        function saveConfig() {
            GOOGLE_SCRIPT_URL = document.getElementById('googleScriptUrl').value;
            localStorage.setItem(GOOGLE_URL_KEY, GOOGLE_SCRIPT_URL);
            alert('‚úÖ Configuration sauvegard√©e !');
        }
        
        function changePassword() {
            const newPass = document.getElementById('newPassword').value;
            if (newPass.length < 4) {
                alert('‚ö†Ô∏è Le mot de passe doit contenir au moins 4 caract√®res');
                return;
            }
            adminPassword = newPass;
            localStorage.setItem(ADMIN_PASSWORD_KEY, newPass);
            document.getElementById('newPassword').value = '';
            alert('‚úÖ Mot de passe modifi√© !');
        }
        
        function clearAllData() {
            if (confirm('‚ö†Ô∏è ATTENTION : Cela va supprimer TOUTES les r√©ponses collect√©es. Cette action est irr√©versible. Continuer ?')) {
                responses = [];
                localStorage.setItem(RESPONSES_KEY, JSON.stringify(responses));
                refreshStats();
                alert('‚úÖ Toutes les donn√©es ont √©t√© effac√©es');
            }
        }
        
        function exportCSV() {
            if (responses.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            let csv = 'Date;';
            csv += questions.map(q => q.question).join(';') + '\n';
            responses.forEach(r => {
                csv += new Date(r.timestamp).toLocaleString('fr-FR') + ';';
                csv += questions.map(q => {
                    let answer = r[q.id];
                    if (q.type === 'scale' && typeof answer === 'number') answer = q.options[answer];
                    return (answer || '').toString().replace(/;/g, ',');
                }).join(';') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'reponses_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }
    </script>
</body>
</html>