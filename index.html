<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire - Gestion Locative</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #4A90E2; font-size: 2.5em; margin-bottom: 10px; }
        h2 { color: #333; font-size: 1.5em; margin-bottom: 20px; }
        h3 { color: #4A90E2; margin-bottom: 15px; margin-top: 25px; }
        .subtitle { color: #666; font-size: 1.1em; margin-bottom: 30px; }
        .intro-text { color: #555; font-size: 1.05em; margin-bottom: 25px; line-height: 1.6; }
        .question { margin-bottom: 30px; }
        .question h2 { color: #333; font-size: 1.3em; margin-bottom: 15px; }
        .question-helper { color: #888; font-size: 0.9em; margin-bottom: 10px; font-style: italic; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .option {
            padding: 15px 20px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        .option:hover { background: #e3f2fd; border-color: #4A90E2; }
        .option.selected { background: #4A90E2; color: white; border-color: #4A90E2; }
        .button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .button:hover { background: #357ABD; transform: translateY(-2px); }
        .button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .button-small { padding: 8px 16px; font-size: 0.9em; margin: 5px; }
        .button-success { background: #28a745; }
        .button-success:hover { background: #218838; }
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill { height: 100%; background: #4A90E2; transition: width 0.3s; }
        .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .back-button { background: #999; }
        .back-button:hover { background: #777; }
        textarea, input[type="text"], input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            margin-bottom: 10px;
        }
        textarea { resize: vertical; min-height: 100px; }
        textarea:focus, input:focus { outline: none; border-color: #4A90E2; }
        .success-message { text-align: center; padding: 60px 20px; }
        .success-message h2 { color: #4A90E2; font-size: 2.5em; margin-bottom: 20px; }
        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .hidden { display: none; }
        .admin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
        }
        .admin-link:hover { background: rgba(0,0,0,0.9); }
        .response-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .response-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        .response-data {
            font-size: 0.9em;
            line-height: 1.8;
        }
        .stat-card {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stat-value { font-size: 2.5em; font-weight: bold; }
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .admin-tab {
            padding: 15px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95em;
            color: #666;
        }
        .admin-tab:hover { color: #4A90E2; }
        .admin-tab.active { color: #4A90E2; border-bottom-color: #4A90E2; font-weight: bold; }
        .admin-content { display: none; }
        .admin-content.active { display: block; }
        .chart-section { margin-bottom: 30px; }
        .chart-bar { margin-bottom: 15px; }
        .chart-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .bar-container { height: 30px; background: #f0f0f0; border-radius: 5px; overflow: hidden; }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4A90E2, #357ABD);
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .segment-card {
            background: #f8f9fa;
            border-left: 4px solid #4A90E2;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
        }
        .segment-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #4A90E2;
            margin-bottom: 10px;
        }
        .segment-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-box-value {
            font-size: 2em;
            font-weight: bold;
            color: #4A90E2;
        }
        .stat-box-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        .insight-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="userView">
            <div id="intro">
                <h1>üìã Questionnaire</h1>
                <p class="intro-text">G√©rer sa location : paperasse, litiges, temps perdu, argent perdu... Et si un service g√©rait TOUT pour vous ET am√©liorait votre relation avec votre propri√©taire ?</p>
                <p class="subtitle">‚è±Ô∏è 3 minutes ‚Ä¢ üîí Anonyme ‚Ä¢ üí° Aidez-nous √† cr√©er le service dont VOUS avez besoin</p>
                <button class="button" onclick="startSurvey()">Commencer</button>
            </div>
            
            <div id="surveyQuestions" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <p id="progressText" style="color: #666; margin-bottom: 20px;"></p>
                <div id="questionContainer"></div>
                <div class="nav-buttons">
                    <button class="button back-button" id="prevBtn" onclick="previousQuestion()" style="display:none">‚Üê Pr√©c√©dent</button>
                    <button class="button" id="nextBtn" onclick="nextQuestion()" disabled>Suivant ‚Üí</button>
                </div>
            </div>
            
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Enregistrement en cours...</p>
            </div>
            
            <div id="thankYou" class="hidden">
                <div class="success-message">
                    <h2>‚úÖ Merci !</h2>
                    <p class="subtitle">Votre participation a √©t√© enregistr√©e.</p>
                </div>
            </div>
            
            <div id="errorView" class="hidden">
                <div class="error-message">
                    <h3>‚ö†Ô∏è Erreur d'enregistrement</h3>
                    <p id="errorMessage"></p>
                </div>
                <button class="button" onclick="location.reload()">R√©essayer</button>
            </div>
        </div>
        
        <div id="adminLogin" class="hidden">
            <h1>üîê Admin</h1>
            <p class="subtitle">Mot de passe administrateur</p>
            <input type="password" id="adminPassword" placeholder="Mot de passe" onkeypress="if(event.key==='Enter') adminLogin()">
            <button class="button" onclick="adminLogin()">Connexion</button>
            <p id="loginError" class="error-message hidden">Mot de passe incorrect</p>
            <button class="button back-button" onclick="showMainView()">‚Üê Retour</button>
        </div>
        
        <div id="adminDashboard" class="hidden">
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <h1>üìä Dashboard Admin</h1>
                <button class="button back-button" onclick="logout()">D√©connexion</button>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showTab('vue-ensemble')">Vue d'ensemble</button>
                <button class="admin-tab" onclick="showTab('segmentation')">Segmentation</button>
                <button class="admin-tab" onclick="showTab('graphiques')">Graphiques</button>
                <button class="admin-tab" onclick="showTab('reponses')">R√©ponses d√©taill√©es</button>
            </div>
            
            <div id="tab-vue-ensemble" class="admin-content active">
                <div style="background: white; border: 2px solid #4A90E2; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 15px 0; color: #4A90E2;">üéØ Objectif : 100 r√©ponses</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold; font-size: 1.1em;" id="progressCount">0 / 100</span>
                        <span style="font-weight: bold; font-size: 1.1em; color: #4A90E2;" id="progressPercent">0%</span>
                    </div>
                    <div style="height: 40px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                        <div id="progressBarFill" style="height: 100%; background: linear-gradient(90deg, #4A90E2, #357ABD); width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1em;">
                            0%
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <span id="remainingText" style="color: #666; font-size: 0.95em;">Il reste 100 r√©ponses √† collecter</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalResponses">0</div>
                        <div>R√©ponses totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgInteret">0%</div>
                        <div>Tr√®s int√©ress√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgIntention">0%</div>
                        <div>Testeraient la b√™ta</div>
                    </div>
                </div>
                
                <button class="button button-success button-small" onclick="loadResponses()">üîÑ Actualiser</button>
                <button class="button button-small" onclick="exportCSV()">üì• Exporter CSV</button>
                
                <h3>Profils des r√©pondants</h3>
                <div id="profilsChart"></div>
                
                <h3>Prix accept√©</h3>
                <div id="prixChart"></div>
            </div>
            
            <div id="tab-segmentation" class="admin-content">
                <h2>Analyse par segments</h2>
                <div id="segmentationContainer"></div>
            </div>
            
            <div id="tab-graphiques" class="admin-content">
                <h2>Statistiques d√©taill√©es</h2>
                <div id="chartsContainer"></div>
            </div>
            
            <div id="tab-reponses" class="admin-content">
                <h2>R√©ponses d√©taill√©es</h2>
                <div id="responsesContainer"></div>
            </div>
        </div>
    </div>
    
    <button class="admin-link" onclick="showAdminLogin()">üîê Admin</button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCS9khxOMGI9xRTi-xaq-vA2mBEUfsx268",
            authDomain: "questionnaire-m2.firebaseapp.com",
            projectId: "questionnaire-m2",
            storageBucket: "questionnaire-m2.firebasestorage.app",
            messagingSenderId: "1017581648987",
            appId: "1:1017581648987:web:d9445be08a02cc42b7937e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        
        console.log('‚úÖ Firebase initialis√© correctement');
    </script>

    <script>
        const ADMIN_PASSWORD = 'admin123';
        
        const questions = [
            // BLOC 1 : SEGMENTATION
            { id: 'statut', question: 'Quel est votre statut actuel ?', type: 'single', options: ['√âtudiant(e)', 'Salari√©(e)', 'En recherche d\'emploi', 'Ind√©pendant(e)', 'Autre'] },
            
            // Si √©tudiant - profil √©quilibr√© (fran√ßais vs international)
            { id: 'etudiant_profil', question: 'Quel est votre profil ?', type: 'single', condition: { questionId: 'statut', value: '√âtudiant(e)' }, options: ['√âtudiant(e) fran√ßais(e) - mes parents g√®rent', '√âtudiant(e) fran√ßais(e) - je g√®re seul(e)', '√âtudiant(e) international(e) - arriv√©(e) r√©cemment', '√âtudiant(e) international(e) - install√©(e) depuis longtemps'] },
            
            // Si salari√© - profil √©quilibr√© (stable vs mobilit√©)
            { id: 'salarie_profil', question: 'Quelle est votre situation professionnelle ?', type: 'single', condition: { questionId: 'statut', value: 'Salari√©(e)' }, options: ['CDI stable depuis plusieurs ann√©es', 'Nouvel emploi (moins d\'un an)', 'Mutation r√©cente en France (autre r√©gion)', 'Mutation r√©cente depuis l\'√©tranger', 'CDD ou int√©rim'] },
            
            // Si recherche emploi - nouvelle exploration
            { id: 'recherche_emploi_situation', question: 'Quelle est votre situation actuelle ?', type: 'single', condition: { questionId: 'statut', value: 'En recherche d\'emploi' }, options: ['Fin de CDD/licenciement r√©cent', 'Recherche depuis plusieurs mois', 'Jeune dipl√¥m√©(e) en recherche', 'Reconversion professionnelle'] },
            
            // Si ind√©pendant - nouvelle exploration
            { id: 'independant_anciennete', question: 'Depuis combien de temps √™tes-vous ind√©pendant(e) ?', type: 'single', condition: { questionId: 'statut', value: 'Ind√©pendant(e)' }, options: ['Moins de 6 mois (d√©but d\'activit√©)', '6 mois √† 2 ans', 'Plus de 2 ans'] },
            
            { id: 'age', question: 'Quelle est votre tranche d\'√¢ge ?', type: 'single', options: ['18-24 ans', '25-34 ans', '35-44 ans', '45 ans et plus'] },
            
            { id: 'situation_familiale', question: 'Situation familiale ?', type: 'single', options: ['Seul(e) sans enfant', 'En couple sans enfant', 'Parent seul avec enfant(s)', 'En couple avec enfant(s)', 'Colocation'] },
            
            // Si parent seul - exploration approfondie
            { id: 'parent_seul_nb_enfants', question: 'Combien d\'enfants avez-vous √† charge ?', type: 'single', condition: { questionId: 'situation_familiale', value: 'Parent seul avec enfant(s)' }, options: ['1 enfant', '2 enfants', '3 enfants ou plus'] },
            
            // Si colocation - nouvelle exploration
            { id: 'colocation_type', question: 'Quel type de colocation ?', type: 'single', condition: { questionId: 'situation_familiale', value: 'Colocation' }, options: ['Colocation √©tudiante', 'Colocation jeunes actifs', 'Colocation interg√©n√©rationnelle', 'Autre'] },
            
            { id: 'statut_locatif', question: '√ätes-vous actuellement locataire ?', type: 'single', options: ['Oui, locataire', 'Non, propri√©taire', 'H√©berg√©(e)', 'En recherche de logement'] },
            
            // BLOC 2 : RELATION PROPRI√âTAIRE/LOCATAIRE
            { id: 'qualite_relation_proprio', question: 'Comment d√©cririez-vous votre relation avec votre propri√©taire/agence ?', type: 'single', condition: { questionId: 'statut_locatif', value: 'Oui, locataire' }, options: ['Excellente - tr√®s r√©actif et arrangeant', 'Bonne - correct dans l\'ensemble', 'Moyenne - quelques tensions occasionnelles', 'Mauvaise - conflits fr√©quents', 'Tr√®s mauvaise - relation d√©grad√©e', 'Aucun contact'] },
            
            { id: 'problemes_proprio', question: 'Avez-vous d√©j√† rencontr√© ces probl√®mes avec votre propri√©taire/agence ?', helper: 'Plusieurs choix possibles', type: 'multiple', options: ['R√©parations non effectu√©es ou retard√©es', 'Propri√©taire qui entre sans pr√©venir', 'Augmentation de loyer abusive', 'Refus de restituer la caution', 'Charges gonfl√©es ou non justifi√©es', 'Harc√®lement ou pressions', 'Travaux non annonc√©s', 'Non-respect du bail', 'Aucun probl√®me'] },
            
            // BLOC 3 : D√âCOUVERTE PAIN POINTS
            { id: 'plus_grosse_galere', question: 'Quelle a √©t√© votre PLUS GROSSE difficult√© en tant que locataire ?', helper: 'D√©crivez bri√®vement (optionnel)', type: 'text', options: [] },
            
            { id: 'difficultes_rencontrees', question: 'Quelles difficult√©s avez-vous rencontr√©es en tant que locataire ?', helper: 'Plusieurs choix possibles', type: 'multiple', options: ['R√©cup√©rer ma caution', 'Comprendre et g√©rer les d√©marches APL', 'Trouver les meilleurs contrats √©nergie/assurance', 'Faire respecter mes droits face au propri√©taire', 'Comprendre mon bail et ses clauses', 'G√©rer un conflit ou litige', 'Constituer un dossier de location solide', 'Trouver un garant', 'Manque de temps pour tout g√©rer', 'Revenus irr√©guliers compliquent la location', 'Aucune difficult√©'] },
            
            { id: 'argent_perdu', question: 'Avez-vous d√©j√† perdu de l\'argent √† cause d\'un probl√®me locatif ?', helper: 'Caution non restitu√©e, charges abusives, mauvais contrats...', type: 'single', options: ['Oui, plus de 1000‚Ç¨', 'Oui, entre 500‚Ç¨ et 1000‚Ç¨', 'Oui, entre 100‚Ç¨ et 500‚Ç¨', 'Oui, moins de 100‚Ç¨', 'Non, jamais'] },
            
            { id: 'temps_perdu', question: 'Combien de temps perdez-vous par an avec toutes vos d√©marches de locataire ?', helper: 'Paperasse, APL, contrats, litiges...', type: 'single', options: ['Moins de 2 heures', '2 √† 5 heures', '5 √† 10 heures', '10 √† 20 heures', 'Plus de 20 heures'] },
            
            // BLOC 4 : VALIDATION SOLUTION
            { id: 'interet_solution', question: 'Seriez-vous int√©ress√©(e) par un service qui g√®re tout pour vous ET am√©liore votre relation avec votre propri√©taire ?', helper: 'Gestion compl√®te (APL, contrats, bail, litiges) + m√©diation propri√©taire', type: 'scale', options: ['Pas du tout int√©ress√©(e)', 'Peu int√©ress√©(e)', 'Moyennement int√©ress√©(e)', 'Tr√®s int√©ress√©(e)', 'Extr√™mement int√©ress√©(e)'] },
            
            { id: 'benefice_prioritaire', question: 'Quel serait le PLUS GRAND b√©n√©fice pour vous ?', type: 'single', options: ['S√âCURIT√â : Protection juridique + caution garantie', '√âCONOMIES : Optimisation contrats (√©nergie, assurance)', 'TEMPS : Z√©ro paperasse (APL automatique, gestion compl√®te)', 'S√âR√âNIT√â : Meilleure relation avec le propri√©taire (m√©diation)', 'TOUT EN UN : Service complet (s√©curit√© + √©conomies + temps + s√©r√©nit√©)'] },
            
            { id: 'fonctionnalite_cle', question: 'Quelle fonctionnalit√© r√®glerait VOTRE plus gros probl√®me ?', type: 'single', options: ['Garantie r√©cup√©ration caution (100% rembours√©e)', 'Assistant pour g√©rer les conflits propri√©taire', 'Gestion APL automatique (z√©ro d√©marche)', 'Optimisation automatique √©nergie/assurance (√©conomies garanties)', 'Aide constitution dossier + recherche garant', 'V√©rification bail + alerte si probl√®me', 'Service complet tout-en-un'] },
            
            { id: 'prix_acceptable', question: 'Combien seriez-vous pr√™t(e) √† payer par mois pour un service qui vous fait gagner du temps ET de l\'argent ?', type: 'single', options: ['0‚Ç¨ (je ne paierais pas)', '5 √† 10‚Ç¨/mois', '10 √† 15‚Ç¨/mois', '15 √† 20‚Ç¨/mois', '20‚Ç¨/mois ou plus'] },
            
            { id: 'intention_utilisation', question: 'Si ce service existait demain, l\'utiliseriez-vous ?', type: 'single', options: ['Oui, certainement (je m\'inscris tout de suite)', 'Oui, probablement (j\'essaierais)', 'Peut-√™tre', 'Probablement pas', 'Non'] },
            
            // BLOC 5 : INSIGHTS QUALITATIFS
            { id: 'une_chose_ameliorer', question: 'Si vous pouviez am√©liorer UNE SEULE chose dans votre vie de locataire, ce serait quoi ?', helper: 'Optionnel', type: 'text', options: [] },
            
            { id: 'remarques', question: 'Autres remarques ou suggestions ?', helper: 'Optionnel', type: 'text', options: [] }
        ];
        
        let currentQ = 0;
        let answers = {};
        let allResponses = [];
        
        function showMainView() {
            document.getElementById('userView').classList.remove('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('intro').classList.remove('hidden');
            document.getElementById('surveyQuestions').classList.add('hidden');
            document.getElementById('thankYou').classList.add('hidden');
            document.getElementById('errorView').classList.add('hidden');
        }
        
        function showAdminLogin() {
            document.getElementById('userView').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
        }
        
        function startSurvey() {
            currentQ = 0;
            answers = {};
            document.getElementById('intro').classList.add('hidden');
            document.getElementById('surveyQuestions').classList.remove('hidden');
            renderQuestion();
        }
        
        function renderQuestion() {
            while (currentQ < questions.length) {
                const q = questions[currentQ];
                if (q.condition) {
                    const conditionMet = answers[q.condition.questionId] === q.condition.value;
                    if (!conditionMet) {
                        currentQ++;
                        continue;
                    }
                }
                break;
            }
            
            if (currentQ >= questions.length) {
                submitSurvey();
                return;
            }
            
            const q = questions[currentQ];
            const visibleQuestions = questions.filter((question, idx) => {
                if (idx > currentQ) return false;
                if (!question.condition) return true;
                return answers[question.condition.questionId] === question.condition.value;
            });
            const questionNumber = visibleQuestions.length;
            
            document.getElementById('progressBar').style.width = ((currentQ + 1) / questions.length * 100) + '%';
            document.getElementById('progressText').textContent = `Question ${questionNumber}`;
            
            let html = `<div class="question"><h2>${q.question}</h2>`;
            if (q.helper) html += `<p class="question-helper">${q.helper}</p>`;
            
            if (q.type === 'text') {
                html += `<textarea id="answer" placeholder="Votre r√©ponse...">${answers[q.id] || ''}</textarea>`;
            } else {
                html += '<div class="options">';
                q.options.forEach((opt, idx) => {
                    const selected = q.type === 'multiple' ? (answers[q.id] || []).includes(opt) : answers[q.id] === (q.type === 'scale' ? idx : opt);
                    html += `<div class="option ${selected ? 'selected' : ''}" data-idx="${idx}">${opt}</div>`;
                });
                html += '</div>';
            }
            html += '</div>';
            document.getElementById('questionContainer').innerHTML = html;
            
            document.querySelectorAll('.option').forEach((div, idx) => {
                div.addEventListener('click', () => {
                    if (q.type === 'multiple') {
                        if (!answers[q.id]) answers[q.id] = [];
                        const opt = q.options[idx];
                        const index = answers[q.id].indexOf(opt);
                        if (index > -1) answers[q.id].splice(index, 1);
                        else answers[q.id].push(opt);
                        div.classList.toggle('selected');
                    } else {
                        answers[q.id] = q.type === 'scale' ? idx : q.options[idx];
                        document.querySelectorAll('.option').forEach(d => d.classList.remove('selected'));
                        div.classList.add('selected');
                    }
                    updateNextButton();
                });
            });
            
            document.getElementById('prevBtn').style.display = currentQ > 0 ? 'block' : 'none';
            document.getElementById('nextBtn').textContent = currentQ === questions.length - 1 ? '‚úì Terminer' : 'Suivant ‚Üí';
            updateNextButton();
        }
        
        function updateNextButton() {
            const q = questions[currentQ];
            const hasAnswer = q.type === 'text' || (q.type === 'multiple' ? (answers[q.id] || []).length > 0 : answers[q.id] !== undefined);
            document.getElementById('nextBtn').disabled = !hasAnswer;
        }
        
        function nextQuestion() {
            const q = questions[currentQ];
            if (q.type === 'text') {
                const textarea = document.getElementById('answer');
                if (textarea) answers[q.id] = textarea.value;
            }
            if (currentQ < questions.length - 1) {
                currentQ++;
                renderQuestion();
            } else {
                submitSurvey();
            }
        }
        
        function previousQuestion() {
            if (currentQ > 0) {
                currentQ--;
                while (currentQ > 0) {
                    const q = questions[currentQ];
                    if (q.condition) {
                        const conditionMet = answers[q.condition.questionId] === q.condition.value;
                        if (!conditionMet) {
                            currentQ--;
                            continue;
                        }
                    }
                    break;
                }
                renderQuestion();
            }
        }
        
        async function submitSurvey() {
            document.getElementById('surveyQuestions').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            const data = { timestamp: new Date().toISOString(), ...answers };
            questions.forEach(q => {
                if (q.type === 'scale' && typeof data[q.id] === 'number') {
                    data[q.id] = q.options[data[q.id]];
                }
            });
            
            console.log('üì§ Envoi des donn√©es √† Firebase...', data);
            
            try {
                await window.addDoc(window.collection(window.db, 'responses'), data);
                console.log('‚úÖ Donn√©es enregistr√©es avec succ√®s !');
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('thankYou').classList.remove('hidden');
                }, 1000);
            } catch (error) {
                console.error('‚ùå Erreur Firebase:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorView').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = 'Erreur : ' + error.message;
            }
        }
        
        function adminLogin() {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                document.getElementById('loginError').classList.add('hidden');
                document.getElementById('adminPassword').value = '';
                loadResponses();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }
        
        function logout() {
            showMainView();
        }
        
        async function loadResponses() {
            console.log('üì• Chargement des r√©ponses...');
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'responses'));
                allResponses = [];
                querySnapshot.forEach(doc => {
                    allResponses.push({ id: doc.id, ...doc.data() });
                });
                console.log(`‚úÖ ${allResponses.length} r√©ponse(s) charg√©e(s)`);
                analyzeData();
                displayResponses();
                renderCharts();
                renderSegmentation();
            } catch (error) {
                console.error('‚ùå Erreur chargement:', error);
                alert('Erreur lors du chargement des r√©ponses : ' + error.message);
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        function analyzeData() {
            const total = allResponses.length;
            const targetGoal = 100;
            const percent = Math.min(Math.round((total / targetGoal) * 100), 100);
            const remaining = Math.max(targetGoal - total, 0);
            
            // Mise √† jour du compteur de progression
            document.getElementById('progressCount').textContent = `${total} / ${targetGoal}`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
            document.getElementById('progressBarFill').style.width = `${percent}%`;
            document.getElementById('progressBarFill').textContent = `${percent}%`;
            
            if (total >= targetGoal) {
                document.getElementById('remainingText').innerHTML = '<strong style="color: #28a745;">üéâ Objectif atteint ! F√©licitations !</strong>';
                document.getElementById('progressBarFill').style.background = 'linear-gradient(90deg, #28a745, #20c997)';
            } else {
                document.getElementById('remainingText').textContent = `Il reste ${remaining} r√©ponse${remaining > 1 ? 's' : ''} √† collecter`;
            }
            
            // Mise √† jour des statistiques
            document.getElementById('totalResponses').textContent = total;
            
            if (total === 0) return;
            
            // Calcul int√©r√™t (√©chelle 0-4)
            const highInteret = allResponses.filter(r => 
                r.interet_solution === 'Tr√®s int√©ress√©(e)' || 
                r.interet_solution === 'Extr√™mement int√©ress√©(e)' ||
                r.interet_solution === 3 || 
                r.interet_solution === 4
            ).length;
            document.getElementById('avgInteret').textContent = Math.round((highInteret / total) * 100) + '%';
            
            // Calcul test b√™ta
            const testBeta = allResponses.filter(r => r.test_beta === 'Oui, avec plaisir' || r.test_beta === 'Oui, pourquoi pas').length;
            document.getElementById('avgIntention').textContent = Math.round((testBeta / total) * 100) + '%';
            
            // Graphique profils
            renderBarChart('profilsChart', 'statut', 'Profils des r√©pondants');
            renderBarChart('prixChart', 'prix_acceptable', 'Prix acceptable');
        }
        
        function renderBarChart(containerId, questionId, title) {
            const data = {};
            allResponses.forEach(r => {
                const value = r[questionId] || 'Non renseign√©';
                data[value] = (data[value] || 0) + 1;
            });
            
            const total = allResponses.length;
            let html = '<div class="chart-section">';
            
            Object.entries(data)
                .sort((a, b) => b[1] - a[1])
                .forEach(([label, count]) => {
                    const percent = Math.round((count / total) * 100);
                    html += `
                        <div class="chart-bar">
                            <div class="chart-label">
                                <span>${label}</span>
                                <span><strong>${count}</strong> (${percent}%)</span>
                            </div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percent}%">${percent}%</div>
                            </div>
                        </div>`;
                });
            
            html += '</div>';
            document.getElementById(containerId).innerHTML = html;
        }
        
        function renderCharts() {
            const chartsDiv = document.getElementById('chartsContainer');
            let html = '';
            
            questions.forEach(q => {
                if (q.type === 'text') return;
                
                const data = {};
                allResponses.forEach(r => {
                    let answer = r[q.id];
                    if (q.type === 'scale' && typeof answer === 'number') {
                        answer = q.options[answer];
                    }
                    if (q.type === 'multiple') {
                        (answer || []).forEach(a => {
                            data[a] = (data[a] || 0) + 1;
                        });
                    } else {
                        answer = answer || 'Non renseign√©';
                        data[answer] = (data[answer] || 0) + 1;
                    }
                });
                
                const total = allResponses.length;
                html += `<div class="chart-section"><h3>${q.question}</h3>`;
                
                Object.entries(data)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([label, count]) => {
                        const percent = Math.round((count / total) * 100);
                        html += `
                            <div class="chart-bar">
                                <div class="chart-label">
                                    <span>${label}</span>
                                    <span><strong>${count}</strong> (${percent}%)</span>
                                </div>
                                <div class="bar-container">
                                    <div class="bar-fill" style="width: ${percent}%">${percent}%</div>
                                </div>
                            </div>`;
                    });
                
                html += '</div>';
            });
            
            chartsDiv.innerHTML = html;
        }
        
        function renderSegmentation() {
            const segmentsDiv = document.getElementById('segmentationContainer');
            
            if (allResponses.length === 0) {
                segmentsDiv.innerHTML = '<p>Aucune donn√©e disponible</p>';
                return;
            }
            
            // Segmentation par statut
            const segments = {};
            allResponses.forEach(r => {
                const statut = r.statut || 'Non renseign√©';
                if (!segments[statut]) {
                    segments[statut] = {
                        count: 0,
                        highInteret: 0,
                        testBeta: 0,
                        prix1015: 0,
                        prix1520: 0
                    };
                }
                
                segments[statut].count++;
                
                if (r.interet_solution === 'Tr√®s int√©ress√©(e)' || r.interet_solution === 'Extr√™mement int√©ress√©(e)' || r.interet_solution === 3 || r.interet_solution === 4) {
                    segments[statut].highInteret++;
                }
                
                if (r.test_beta === 'Oui, avec plaisir' || r.test_beta === 'Oui, pourquoi pas') {
                    segments[statut].testBeta++;
                }
                
                if (r.prix_acceptable === '10 √† 15‚Ç¨/mois') {
                    segments[statut].prix1015++;
                }
                
                if (r.prix_acceptable === '15 √† 20‚Ç¨/mois' || r.prix_acceptable === '20‚Ç¨/mois ou plus') {
                    segments[statut].prix1520++;
                }
            });
            
            let html = '';
            
            Object.entries(segments)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([statut, data]) => {
                    const interetPct = Math.round((data.highInteret / data.count) * 100);
                    const betaPct = Math.round((data.testBeta / data.count) * 100);
                    const isPriority = interetPct >= 50;
                    
                    html += `
                        <div class="segment-card" style="border-left-color: ${isPriority ? '#28a745' : '#4A90E2'}">
                            <div class="segment-title">
                                ${statut} ${isPriority ? 'üéØ' : ''}
                                <span style="font-size: 0.9em; color: #666; font-weight: normal;">(${data.count} r√©ponses)</span>
                            </div>
                            
                            ${isPriority ? '<div class="insight-box"><strong>üéØ Segment prioritaire</strong> - Taux d\'int√©r√™t √©lev√© (‚â•50%)</div>' : ''}
                            
                            <div class="segment-stats">
                                <div class="stat-box">
                                    <div class="stat-box-value">${interetPct}%</div>
                                    <div class="stat-box-label">Tr√®s int√©ress√©s</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-value">${betaPct}%</div>
                                    <div class="stat-box-label">Testeraient la b√™ta</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-value">${data.prix1015 + data.prix1520}</div>
                                    <div class="stat-box-label">Acceptent 10-20‚Ç¨/mois</div>
                                </div>
                            </div>
                        </div>`;
                });
            
            segmentsDiv.innerHTML = html;
        }
        
        function displayResponses() {
            if (allResponses.length === 0) {
                document.getElementById('responsesContainer').innerHTML = '<p style="color: #666; margin-top: 20px;">Aucune r√©ponse pour le moment.</p>';
                return;
            }
            
            let html = '';
            allResponses.forEach((r, idx) => {
                const date = new Date(r.timestamp).toLocaleString('fr-FR');
                html += `<div class="response-item">
                    <div class="response-header">R√©ponse #${idx + 1} - ${date}</div>
                    <div class="response-data">`;
                
                questions.forEach(q => {
                    let answer = r[q.id];
                    if (q.type === 'scale' && typeof answer === 'number') answer = q.options[answer];
                    if (q.type === 'multiple') answer = (answer || []).join(', ');
                    if (answer) {
                        html += `<div><strong>${q.question}</strong><br>${answer}</div><br>`;
                    }
                });
                
                html += `</div></div>`;
            });
            document.getElementById('responsesContainer').innerHTML = html;
        }
        
        function exportCSV() {
            if (allResponses.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            
            let csv = 'Date;' + questions.map(q => q.question.replace(/;/g, ',')).join(';') + '\n';
            allResponses.forEach(r => {
                csv += new Date(r.timestamp).toLocaleString('fr-FR') + ';';
                csv += questions.map(q => {
                    let answer = r[q.id];
                    if (q.type === 'scale' && typeof answer === 'number') answer = q.options[answer];
                    if (q.type === 'multiple') answer = (answer || []).join(' | ');
                    return (answer || '').toString().replace(/;/g, ',');
                }).join(';') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'reponses_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }
    </script>
</body>
</html>
