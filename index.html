<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire - Gestion Locative</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        h2 { color: #333; font-size: 1.5em; margin-bottom: 20px; }
        .subtitle { color: #666; font-size: 1.1em; margin-bottom: 30px; }
        .intro-text { color: #555; font-size: 1.05em; margin-bottom: 25px; line-height: 1.6; }
        .question { margin-bottom: 30px; }
        .question h2 { color: #333; font-size: 1.3em; margin-bottom: 15px; }
        .question-helper { color: #888; font-size: 0.9em; margin-bottom: 10px; font-style: italic; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .option {
            padding: 15px 20px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        .option:hover { background: #e3f2fd; border-color: #667eea; }
        .option.selected { background: #667eea; color: white; border-color: #667eea; }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .button:hover { background: #5568d3; transform: translateY(-2px); }
        .button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill { height: 100%; background: #667eea; transition: width 0.3s; }
        .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .back-button { background: #999; }
        .back-button:hover { background: #777; }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }
        textarea:focus { outline: none; border-color: #667eea; }
        .success-message { text-align: center; padding: 60px 20px; }
        .success-message h2 { color: #667eea; font-size: 2.5em; margin-bottom: 20px; }
        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="intro">
            <h1>üìã Questionnaire</h1>
            <p class="intro-text">La vie de locataire, c'est souvent gal√®re : paperasse, litiges, caution... Et si un service s'occupait de TOUT pour vous ?</p>
            <p class="subtitle">Ce questionnaire prend 3 minutes. Vos r√©ponses sont anonymes.</p>
            <button class="button" onclick="startSurvey()">Commencer</button>
        </div>
        
        <div id="surveyQuestions" class="hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p id="progressText" style="color: #666; margin-bottom: 20px;"></p>
            <div id="questionContainer"></div>
            <div class="nav-buttons">
                <button class="button back-button" id="prevBtn" onclick="previousQuestion()" style="display:none">‚Üê Pr√©c√©dent</button>
                <button class="button" id="nextBtn" onclick="nextQuestion()" disabled>Suivant ‚Üí</button>
            </div>
        </div>
        
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Enregistrement...</p>
        </div>
        
        <div id="thankYou" class="hidden">
            <div class="success-message">
                <h2>‚úÖ Merci !</h2>
                <p class="subtitle">Votre participation a √©t√© enregistr√©e.</p>
            </div>
        </div>
        
        <div id="errorView" class="hidden">
            <div style="background: #fee; border: 2px solid #fcc; color: #c00; padding: 15px; border-radius: 10px; margin: 20px 0;">
                <h3>‚ö†Ô∏è Erreur</h3>
                <p id="errorMessage">Erreur d'enregistrement.</p>
            </div>
            <button class="button" onclick="location.reload()">R√©essayer</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCS9khxOMGI9xRTi-xaq-vA2mBEUfsx268",
            authDomain: "questionnaire-m2.firebaseapp.com",
            projectId: "questionnaire-m2",
            storageBucket: "questionnaire-m2.firebasestorage.app",
            messagingSenderId: "1017581648987",
            appId: "1:1017581648987:web:d9445be08a02cc42b7937e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
    </script>

    <script>
        const questions = [
            { id: 'statut_principal', question: 'Quel est votre statut actuel ?', type: 'single', options: ['√âtudiant(e)', 'Salari√©(e)', 'Ind√©pendant(e) / Auto-entrepreneur', 'En recherche d\'emploi', 'Retrait√©(e)', 'Autre'] },
            { id: 'etudiant_origine', question: '√ätes-vous √©tudiant(e) fran√ßais(e) ou √©tranger/√®re ?', type: 'single', condition: { questionId: 'statut_principal', value: '√âtudiant(e)' }, options: ['√âtudiant(e) fran√ßais(e)', '√âtudiant(e) √©tranger/√®re'] },
            { id: 'etudiant_gestion', question: 'Qui s\'occupe de la gestion de votre logement ?', type: 'single', condition: { questionId: 'statut_principal', value: '√âtudiant(e)' }, options: ['Mes parents g√®rent tout', 'Je g√®re moi-m√™me', 'Mes parents m\'aident mais je g√®re en partie', 'Un garant/tuteur s\'en occupe'] },
            { id: 'salarie_anciennete', question: 'Depuis combien de temps √™tes-vous salari√©(e) ?', type: 'single', condition: { questionId: 'statut_principal', value: 'Salari√©(e)' }, options: ['Moins de 6 mois (nouvel emploi / mutation)', '6 mois √† 2 ans', '2 √† 5 ans', 'Plus de 5 ans'] },
            { id: 'salarie_mobilite', question: 'Avez-vous d√©m√©nag√© r√©cemment pour votre travail ?', type: 'single', condition: { questionId: 'statut_principal', value: 'Salari√©(e)' }, options: ['Oui, il y a moins de 6 mois', 'Oui, il y a 6-12 mois', 'Non, je suis stable g√©ographiquement', 'Je pr√©vois de d√©m√©nager prochainement'] },
            { id: 'age', question: 'Quelle est votre tranche d\'√¢ge ?', type: 'single', options: ['18-24 ans', '25-34 ans', '35-44 ans', '45-54 ans', '55 ans et plus'] },
            { id: 'situation_familiale', question: 'Quelle est votre situation familiale ?', type: 'single', options: ['C√©libataire sans enfant', 'En couple sans enfant', 'Parent seul avec enfant(s)', 'En couple avec enfant(s)', 'Colocation', 'Autre'] },
            { id: 'parent_solo_difficultes', question: 'En tant que parent seul, quelles difficult√©s sp√©cifiques rencontrez-vous ?', helper: 'Plusieurs choix possibles', type: 'multiple', condition: { questionId: 'situation_familiale', value: 'Parent seul avec enfant(s)' }, options: ['Difficult√©s √† constituer le dossier de location', 'Montants de loyer trop √©lev√©s par rapport aux revenus', 'Gestion APL complexe avec enfants √† charge', 'Manque de temps pour les d√©marches administratives', 'Pas de difficult√©s particuli√®res'] },
            { id: 'situation_locative', question: 'Situation actuelle de logement ?', type: 'single', options: ['Je suis locataire actuellement', 'Je suis propri√©taire', 'Je recherche activement un logement', 'H√©berg√©(e) temporairement', 'Autre situation'] },
            { id: 'anciennete_location', question: 'Depuis combien de temps √™tes-vous locataire de votre logement actuel ?', type: 'single', condition: { questionId: 'situation_locative', value: 'Je suis locataire actuellement' }, options: ['Moins de 6 mois', '6 mois √† 1 an', '1 √† 3 ans', '3 √† 5 ans', 'Plus de 5 ans'] },
            { id: 'type_bailleur', question: 'Qui est votre bailleur ?', type: 'single', condition: { questionId: 'situation_locative', value: 'Je suis locataire actuellement' }, options: ['Particulier (propri√©taire direct)', 'Agence immobili√®re', 'Bailleur social (HLM, logement social)', 'R√©sidence √©tudiante / CROUS', 'Je ne sais pas'] },
            { id: 'part_loyer', question: 'Quelle part de vos revenus repr√©sente votre loyer (charges comprises) ?', type: 'single', condition: { questionId: 'situation_locative', value: 'Je suis locataire actuellement' }, options: ['Moins de 25%', '25% √† 33%', '33% √† 40%', 'Plus de 40%', 'Je ne sais pas / Ne paie pas mon loyer'] },
            { id: 'difficultes', question: 'Quelles difficult√©s rencontrez-vous ou avez-vous rencontr√©es en tant que locataire ?', helper: 'Plusieurs choix possibles', type: 'multiple', options: ['Comprendre les clauses de mon bail', 'D√©marches administratives (APL, attestations, courriers...)', 'R√©cup√©ration de la caution', 'Contrats √©nergie/assurance trop chers', 'M√©connaissance de mes droits face au propri√©taire', 'Litiges ou tensions avec le propri√©taire/agence', 'Charges √©lev√©es ou incompr√©hensibles', 'Manque de temps pour g√©rer tout cela', 'Aucune difficult√© particuli√®re'] },
            { id: 'perte_argent', question: 'Avez-vous d√©j√† perdu de l\'argent √† cause d\'un probl√®me locatif ?', helper: 'Caution non restitu√©e, charges abusives, mauvais contrats...', type: 'single', options: ['Oui, plus de 1 000‚Ç¨', 'Oui, entre 500‚Ç¨ et 1 000‚Ç¨', 'Oui, entre 100‚Ç¨ et 500‚Ç¨', 'Oui, moins de 100‚Ç¨', 'Non, jamais'] },
            { id: 'interet', question: 'Seriez-vous int√©ress√©(e) par un service qui g√®re l\'ensemble de vos besoins de locataire :', helper: 'V√©rification bail ‚Ä¢ Optimisation contrats ‚Ä¢ Gestion APL ‚Ä¢ Assistance juridique ‚Ä¢ Automatisation d√©marches', type: 'scale', options: ['Peu ou pas int√©ress√©(e)', 'Moyennement int√©ress√©(e)', 'Tr√®s int√©ress√©(e)', 'Extr√™mement int√©ress√©(e)'] },
            { id: 'fonctionnalite_prioritaire', question: 'Quelle fonctionnalit√© vous int√©resserait le PLUS en priorit√© ?', helper: 'Un seul choix', type: 'single', options: ['Protection juridique + suivi de caution + gestion des litiges', 'Optimisation automatique des contrats (√©nergie, assurance) au meilleur prix', 'Automatisation compl√®te des d√©marches administratives (APL, attestations...)', 'Analyse du bail + v√©rification conformit√©', 'Service complet avec tableau de bord centralis√©'] },
            { id: 'prix', question: 'Quel prix seriez-vous pr√™t(e) √† payer mensuellement pour ce service complet ?', type: 'single', options: ['5 √† 10‚Ç¨/mois', '10 √† 15‚Ç¨/mois', '15 √† 20‚Ç¨/mois', '20 √† 30‚Ç¨/mois', 'Plus de 30‚Ç¨/mois', 'Je ne paierais pas pour ce service'] },
            { id: 'utilisation', question: 'Si ce service √©tait disponible d√®s maintenant, l\'utiliseriez-vous ?', type: 'single', options: ['Oui, certainement', 'Oui, probablement', 'Peut-√™tre', 'Probablement pas', 'Non'] },
            { id: 'remarque', question: 'Une remarque, suggestion ou pr√©cision sur votre situation ?', helper: 'Optionnel', type: 'text', options: [] }
        ];
        
        let currentQ = 0;
        let answers = {};
        
        function startSurvey() {
            currentQ = 0;
            answers = {};
            document.getElementById('intro').classList.add('hidden');
            document.getElementById('surveyQuestions').classList.remove('hidden');
            renderQuestion();
        }
        
        function renderQuestion() {
            // Sauter les questions dont la condition n'est pas remplie
            while (currentQ < questions.length) {
                const q = questions[currentQ];
                if (q.condition) {
                    const conditionMet = answers[q.condition.questionId] === q.condition.value;
                    if (!conditionMet) {
                        currentQ++;
                        continue;
                    }
                }
                break;
            }
            
            if (currentQ >= questions.length) {
                submitSurvey();
                return;
            }
            
            const q = questions[currentQ];
            const visibleQuestions = questions.filter((question, idx) => {
                if (idx > currentQ) return false;
                if (!question.condition) return true;
                return answers[question.condition.questionId] === question.condition.value;
            });
            const questionNumber = visibleQuestions.length;
            
            document.getElementById('progressBar').style.width = ((currentQ + 1) / questions.length * 100) + '%';
            document.getElementById('progressText').textContent = `Question ${questionNumber}`;
            
            let html = `<div class="question"><h2>${q.question}</h2>`;
            if (q.helper) html += `<p class="question-helper">${q.helper}</p>`;
            
            if (q.type === 'text') {
                html += `<textarea id="answer" placeholder="Votre r√©ponse...">${answers[q.id] || ''}</textarea>`;
            } else {
                html += '<div class="options">';
                q.options.forEach((opt, idx) => {
                    const selected = q.type === 'multiple' ? (answers[q.id] || []).includes(opt) : answers[q.id] === (q.type === 'scale' ? idx : opt);
                    html += `<div class="option ${selected ? 'selected' : ''}" data-idx="${idx}">${opt}</div>`;
                });
                html += '</div>';
            }
            html += '</div>';
            document.getElementById('questionContainer').innerHTML = html;
            
            document.querySelectorAll('.option').forEach((div, idx) => {
                div.addEventListener('click', () => {
                    if (q.type === 'multiple') {
                        if (!answers[q.id]) answers[q.id] = [];
                        const opt = q.options[idx];
                        const index = answers[q.id].indexOf(opt);
                        if (index > -1) answers[q.id].splice(index, 1);
                        else answers[q.id].push(opt);
                        div.classList.toggle('selected');
                    } else {
                        answers[q.id] = q.type === 'scale' ? idx : q.options[idx];
                        document.querySelectorAll('.option').forEach(d => d.classList.remove('selected'));
                        div.classList.add('selected');
                    }
                    updateNextButton();
                });
            });
            
            document.getElementById('prevBtn').style.display = currentQ > 0 ? 'block' : 'none';
            document.getElementById('nextBtn').textContent = currentQ === questions.length - 1 ? '‚úì Terminer' : 'Suivant ‚Üí';
            updateNextButton();
        }
        
        function updateNextButton() {
            const q = questions[currentQ];
            const hasAnswer = q.type === 'text' || (q.type === 'multiple' ? (answers[q.id] || []).length > 0 : answers[q.id] !== undefined);
            document.getElementById('nextBtn').disabled = !hasAnswer;
        }
        
        function nextQuestion() {
            const q = questions[currentQ];
            if (q.type === 'text') {
                const textarea = document.getElementById('answer');
                if (textarea) answers[q.id] = textarea.value;
            }
            if (currentQ < questions.length - 1) {
                currentQ++;
                renderQuestion();
            } else {
                submitSurvey();
            }
        }
        
        function previousQuestion() {
            if (currentQ > 0) {
                currentQ--;
                while (currentQ > 0) {
                    const q = questions[currentQ];
                    if (q.condition) {
                        const conditionMet = answers[q.condition.questionId] === q.condition.value;
                        if (!conditionMet) {
                            currentQ--;
                            continue;
                        }
                    }
                    break;
                }
                renderQuestion();
            }
        }
        
        async function submitSurvey() {
            document.getElementById('surveyQuestions').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            const data = { timestamp: new Date().toISOString(), ...answers };
            questions.forEach(q => {
                if (q.type === 'scale' && typeof data[q.id] === 'number') {
                    data[q.id] = q.options[data[q.id]];
                }
            });
            
            try {
                await window.addDoc(window.collection(window.db, 'responses'), data);
                console.log('‚úÖ R√©ponse enregistr√©e dans Firebase');
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('thankYou').classList.remove('hidden');
                }, 1000);
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorView').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = 'Erreur: ' + error.message;
            }
        }
    </script>
</body>
</html>
