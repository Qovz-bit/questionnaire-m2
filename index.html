<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire - Gestion Locative</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        h2 { color: #333; font-size: 1.5em; margin-bottom: 20px; }
        h3 { color: #667eea; margin-bottom: 15px; margin-top: 25px; }
        .subtitle { color: #666; font-size: 1.1em; margin-bottom: 30px; }
        .intro-text { color: #555; font-size: 1.05em; margin-bottom: 25px; line-height: 1.6; }
        .question { margin-bottom: 30px; }
        .question h2 { color: #333; font-size: 1.3em; margin-bottom: 15px; }
        .question-helper { color: #888; font-size: 0.9em; margin-bottom: 10px; font-style: italic; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .option {
            padding: 15px 20px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        .option:hover { background: #e3f2fd; border-color: #667eea; }
        .option.selected { background: #667eea; color: white; border-color: #667eea; }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .button:hover { background: #5568d3; transform: translateY(-2px); }
        .button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .button-small { padding: 8px 16px; font-size: 0.9em; margin: 5px; }
        .button-success { background: #28a745; }
        .button-success:hover { background: #218838; }
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill { height: 100%; background: #667eea; transition: width 0.3s; }
        .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .back-button { background: #999; }
        .back-button:hover { background: #777; }
        textarea, input[type="text"], input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            margin-bottom: 10px;
        }
        textarea { resize: vertical; min-height: 100px; }
        textarea:focus, input:focus { outline: none; border-color: #667eea; }
        .success-message { text-align: center; padding: 60px 20px; }
        .success-message h2 { color: #667eea; font-size: 2.5em; margin-bottom: 20px; }
        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .hidden { display: none; }
        .admin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
        }
        .admin-link:hover { background: rgba(0,0,0,0.9); }
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .admin-tab {
            padding: 15px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95em;
            color: #666;
        }
        .admin-tab:hover { color: #667eea; }
        .admin-tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: bold; }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stat-value { font-size: 2.5em; font-weight: bold; }
        .hypothesis-card {
            border: 3px solid #e0e0e0;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .hypothesis-card.validated { border-color: #28a745; background: #f0fff4; }
        .hypothesis-card.rejected { border-color: #dc3545; background: #fff5f5; }
        .hypothesis-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .hypothesis-result { font-size: 1.5em; font-weight: bold; margin: 10px 0; }
        .hypothesis-detail { color: #666; font-size: 0.95em; line-height: 1.6; }
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
        .insight-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .chart-section { margin-bottom: 30px; }
        .chart-bar { margin-bottom: 15px; }
        .chart-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .bar-container { height: 30px; background: #f0f0f0; border-radius: 5px; overflow: hidden; }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .responses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        .responses-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
        }
        .responses-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .responses-table tr:hover {
            background: #f8f9fa;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .button-danger { background: #dc3545; }
        .button-danger:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <div id="userView">
            <div id="intro">
                <h1>üìã Questionnaire</h1>
                <p class="intro-text">La vie de locataire, c'est souvent gal√®re : paperasse, litiges, caution... Et si un service s'occupait de TOUT pour vous ?</p>
                <p class="subtitle">Ce questionnaire prend 3 minutes. Vos r√©ponses sont anonymes.</p>
                <button class="button" onclick="startSurvey()">Commencer</button>
            </div>
            
            <div id="surveyQuestions" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <p id="progressText" style="color: #666; margin-bottom: 20px;"></p>
                <div id="questionContainer"></div>
                <div class="nav-buttons">
                    <button class="button back-button" id="prevBtn" onclick="previousQuestion()" style="display:none">‚Üê Pr√©c√©dent</button>
                    <button class="button" id="nextBtn" onclick="nextQuestion()" disabled>Suivant ‚Üí</button>
                </div>
            </div>
            
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Enregistrement...</p>
            </div>
            
            <div id="thankYou" class="hidden">
                <div class="success-message">
                    <h2>‚úÖ Merci !</h2>
                    <p class="subtitle">Votre participation a √©t√© enregistr√©e.</p>
                </div>
            </div>
            
            <div id="errorView" class="hidden">
                <div class="error-message">
                    <h3>‚ö†Ô∏è Erreur</h3>
                    <p id="errorMessage">Erreur d'enregistrement.</p>
                </div>
                <button class="button" onclick="location.reload()">R√©essayer</button>
            </div>
        </div>
        
        <div id="adminLogin" class="hidden">
            <h1>üîê Admin</h1>
            <input type="password" id="adminPassword" placeholder="Mot de passe" onkeypress="if(event.key==='Enter') adminLogin()">
            <button class="button" onclick="adminLogin()">Connexion</button>
            <p id="loginError" class="error-message" style="display: none;">Mot de passe incorrect</p>
            <button class="button back-button" onclick="showMainView()">‚Üê Retour</button>
        </div>
        
        <div id="adminDashboard" class="hidden">
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <h1>Dashboard</h1>
                <button class="button back-button" onclick="logout()">D√©connexion</button>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('hypotheses')">Hypoth√®ses</button>
                <button class="admin-tab" onclick="showAdminTab('stats')">Statistiques</button>
                <button class="admin-tab" onclick="showAdminTab('segments')">Segmentation</button>
                <button class="admin-tab" onclick="showAdminTab('responses')">G√©rer r√©ponses</button>
            </div>
            
            <div id="adminHypotheses" class="admin-content">
                <button class="button button-success button-small" onclick="loadResponses()">üîÑ Actualiser</button>
                <button class="button button-small" onclick="exportCSV()">üì• CSV</button>
                <p class="subtitle" id="hypCount">Chargement...</p>
                <div id="hypothesesContainer"></div>
                <div id="businessInsights"></div>
            </div>
            
            <div id="adminStats" class="admin-content hidden">
                <div id="chartsContainer"></div>
            </div>
            
            <div id="adminSegments" class="admin-content hidden">
                <div id="segmentationContainer"></div>
            </div>
            
            <div id="adminResponses" class="admin-content hidden">
                <h2>G√©rer les r√©ponses</h2>
                <p class="subtitle">Cliquez sur "Supprimer" pour retirer une r√©ponse sp√©cifique de la base de donn√©es.</p>
                <div id="responsesTableContainer"></div>
            </div>
        </div>
    </div>
    
    <button class="admin-link" onclick="showAdminLogin()">üîê</button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCS9khxOMGI9xRTi-xaq-vA2mBEUfsx268",
            authDomain: "questionnaire-m2.firebaseapp.com",
            projectId: "questionnaire-m2",
            storageBucket: "questionnaire-m2.firebasestorage.app",
            messagingSenderId: "1017581648987",
            appId: "1:1017581648987:web:d9445be08a02cc42b7937e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
    </script>

    <script>
        const ADMIN_PASSWORD = 'admin123';
        
        const questions = [
            { id: 'profil', question: 'Vous √™tes... ?', type: 'single', options: ['√âtudiant(e) ‚Ä¢ 18-24 ans', 'Salari√©(e) ‚Ä¢ 25-34 ans', 'Salari√©(e) ‚Ä¢ 35+ ans', 'Ind√©pendant(e) / Autre'] },
            { id: 'situation', question: 'Situation actuelle ?', type: 'single', options: ['Je suis locataire actuellement', 'Je suis propri√©taire', 'Je recherche un logement', 'Autre situation'] },
            { id: 'difficultes', question: 'Quelles difficult√©s rencontrez-vous en tant que locataire ?', helper: 'Plusieurs choix possibles', type: 'multiple', options: ['D√©marches administratives (APL, attestations, courriers...)', 'R√©cup√©ration de la caution', 'Contrats √©nergie/assurance trop chers', 'M√©connaissance de mes droits face au propri√©taire', 'Litiges ou tensions avec le propri√©taire/agence', 'Charges √©lev√©es ou incompr√©hensibles', 'Manque de temps pour g√©rer tout cela', 'Aucune difficult√© particuli√®re'] },
            { id: 'perte_argent', question: 'Avez-vous d√©j√† perdu de l\'argent √† cause d\'un probl√®me locatif ?', helper: 'Caution non restitu√©e, charges abusives, mauvais contrats...', type: 'single', options: ['Oui, plus de 500‚Ç¨', 'Oui, entre 100‚Ç¨ et 500‚Ç¨', 'Oui, moins de 100‚Ç¨', 'Non, jamais'] },
            { id: 'interet', question: 'Seriez-vous int√©ress√©(e) par un service qui g√®re l\'ensemble de vos besoins de locataire :', helper: 'V√©rification bail ‚Ä¢ Optimisation contrats ‚Ä¢ Gestion APL ‚Ä¢ Assistance juridique ‚Ä¢ Automatisation d√©marches', type: 'scale', options: ['Peu ou pas int√©ress√©(e)', 'Moyennement int√©ress√©(e)', 'Tr√®s int√©ress√©(e)', 'Extr√™mement int√©ress√©(e)'] },
            { id: 'fonctionnalite', question: 'Quelle fonctionnalit√© vous int√©resserait le plus ?', helper: 'Un seul choix', type: 'single', options: ['Protection juridique + suivi de caution + gestion des litiges', 'Optimisation des contrats au meilleur prix garanti', 'Automatisation des d√©marches administratives', 'Service complet avec tableau de bord centralis√©'] },
            { id: 'prix', question: 'Quel prix seriez-vous pr√™t(e) √† payer mensuellement ?', type: 'single', options: ['5 √† 10‚Ç¨/mois', '10 √† 20‚Ç¨/mois', '20 √† 30‚Ç¨/mois', 'Plus de 30‚Ç¨/mois', 'Je ne paierais pas'] },
            { id: 'utilisation', question: 'Si ce service √©tait disponible d√®s maintenant, l\'utiliseriez-vous ?', type: 'single', options: ['Oui, certainement', 'Oui, probablement', 'Peut-√™tre', 'Non'] },
            { id: 'remarque', question: 'Une remarque ou suggestion ?', helper: 'Optionnel', type: 'text', options: [] }
        ];
        
        let currentQ = 0;
        let answers = {};
        let allResponses = [];
        
        function showMainView() {
            document.getElementById('userView').classList.remove('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('intro').classList.remove('hidden');
            document.getElementById('surveyQuestions').classList.add('hidden');
            document.getElementById('thankYou').classList.add('hidden');
            document.getElementById('errorView').classList.add('hidden');
        }
        
        function showAdminLogin() {
            document.getElementById('userView').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
        }
        
        function showAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById('admin' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            if (tab === 'hypotheses') analyzeHypotheses();
            if (tab === 'stats') renderDetailedStats();
            if (tab === 'segments') renderSegmentation();
            if (tab === 'responses') renderResponsesTable();
        }
        
        function startSurvey() {
            currentQ = 0;
            answers = {};
            document.getElementById('intro').classList.add('hidden');
            document.getElementById('surveyQuestions').classList.remove('hidden');
            renderQuestion();
        }
        
        function renderQuestion() {
            const q = questions[currentQ];
            document.getElementById('progressBar').style.width = ((currentQ + 1) / questions.length * 100) + '%';
            document.getElementById('progressText').textContent = `Question ${currentQ + 1} sur ${questions.length}`;
            
            let html = `<div class="question"><h2>${q.question}</h2>`;
            if (q.helper) html += `<p class="question-helper">${q.helper}</p>`;
            
            if (q.type === 'text') {
                html += `<textarea id="answer" placeholder="Votre r√©ponse...">${answers[q.id] || ''}</textarea>`;
            } else {
                html += '<div class="options">';
                q.options.forEach((opt, idx) => {
                    const selected = q.type === 'multiple' ? (answers[q.id] || []).includes(opt) : answers[q.id] === (q.type === 'scale' ? idx : opt);
                    html += `<div class="option ${selected ? 'selected' : ''}" data-idx="${idx}">${opt}</div>`;
                });
                html += '</div>';
            }
            html += '</div>';
            document.getElementById('questionContainer').innerHTML = html;
            
            document.querySelectorAll('.option').forEach((div, idx) => {
                div.addEventListener('click', () => {
                    if (q.type === 'multiple') {
                        if (!answers[q.id]) answers[q.id] = [];
                        const opt = q.options[idx];
                        const index = answers[q.id].indexOf(opt);
                        if (index > -1) answers[q.id].splice(index, 1);
                        else answers[q.id].push(opt);
                        div.classList.toggle('selected');
                    } else {
                        answers[q.id] = q.type === 'scale' ? idx : q.options[idx];
                        document.querySelectorAll('.option').forEach(d => d.classList.remove('selected'));
                        div.classList.add('selected');
                    }
                    updateNextButton();
                });
            });
            
            document.getElementById('prevBtn').style.display = currentQ > 0 ? 'block' : 'none';
            document.getElementById('nextBtn').textContent = currentQ === questions.length - 1 ? '‚úì Terminer' : 'Suivant ‚Üí';
            updateNextButton();
        }
        
        function updateNextButton() {
            const q = questions[currentQ];
            const hasAnswer = q.type === 'text' || (q.type === 'multiple' ? (answers[q.id] || []).length > 0 : answers[q.id] !== undefined);
            document.getElementById('nextBtn').disabled = !hasAnswer;
        }
        
        function nextQuestion() {
            const q = questions[currentQ];
            if (q.type === 'text') {
                const textarea = document.getElementById('answer');
                if (textarea) answers[q.id] = textarea.value;
            }
            if (currentQ < questions.length - 1) {
                currentQ++;
                renderQuestion();
            } else {
                submitSurvey();
            }
        }
        
        function previousQuestion() {
            if (currentQ > 0) {
                currentQ--;
                renderQuestion();
            }
        }
        
        async function submitSurvey() {
            document.getElementById('surveyQuestions').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            const data = { timestamp: new Date().toISOString(), ...answers };
            questions.forEach(q => {
                if (q.type === 'scale' && typeof data[q.id] === 'number') {
                    data[q.id] = q.options[data[q.id]];
                }
            });
            
            try {
                await window.addDoc(window.collection(window.db, 'responses'), data);
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('thankYou').classList.remove('hidden');
                }, 1000);
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorView').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = 'Erreur: ' + error.message;
            }
        }
        
        function adminLogin() {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('adminPassword').value = '';
                loadResponses();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function logout() {
            showMainView();
        }
        
        async function loadResponses() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'responses'));
                allResponses = [];
                querySnapshot.forEach(doc => {
                    allResponses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                analyzeHypotheses();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur chargement');
            }
        }
        
        function analyzeHypotheses() {
            const total = allResponses.length;
            document.getElementById('hypCount').textContent = `${total} r√©ponse${total > 1 ? 's' : ''}`;
            
            if (total === 0) {
                document.getElementById('hypothesesContainer').innerHTML = '<p>Aucune r√©ponse</p>';
                document.getElementById('businessInsights').innerHTML = '';
                return;
            }
            
            const withDiff = allResponses.filter(r => (r.difficultes || []).length > 0 && !r.difficultes.includes('Aucune difficult√© particuli√®re')).length;
            const withLoss = allResponses.filter(r => r.perte_argent && r.perte_argent !== 'Non, jamais').length;
            const h1p1 = (withDiff / total * 100).toFixed(1);
            const h1p2 = (withLoss / total * 100).toFixed(1);
            const h1 = parseFloat(h1p1) > 60 && parseFloat(h1p2) > 50;
            
            const highInt = allResponses.filter(r => r.interet === 'Tr√®s int√©ress√©(e)' || r.interet === 'Extr√™mement int√©ress√©(e)' || r.interet === 2 || r.interet === 3).length;
            const h2p = (highInt / total * 100).toFixed(1);
            const h2 = parseFloat(h2p) > 40;
            
            const pricing = allResponses.filter(r => r.prix === '10 √† 20‚Ç¨/mois').length;
            const h3p = (pricing / total * 100).toFixed(1);
            const h3 = parseFloat(h3p) > 30;
            
            const intent = allResponses.filter(r => r.utilisation === 'Oui, certainement').length;
            const h4p = (intent / total * 100).toFixed(1);
            const h4 = parseFloat(h4p) > 15;
            
            let html = `<div class="hypothesis-card ${h1 ? 'validated' : 'rejected'}">
                <div class="hypothesis-title"><span>${h1 ? '‚úÖ' : '‚ùå'}</span><span>H1: Probl√®mes co√ªteux</span><span class="badge ${h1 ? 'badge-success' : 'badge-danger'}">${h1 ? 'VALID√âE' : 'NON'}</span></div>
                <div class="hypothesis-result">${h1p1}% difficult√©s ‚Ä¢ ${h1p2}% pertes</div>
                <div class="hypothesis-detail"><strong>Crit√®re:</strong> >60% et >50%<br><strong>Conclusion:</strong> ${h1 ? 'Valid√©' : 'Insuffisant'}</div>
            </div>`;
            
            html += `<div class="hypothesis-card ${h2 ? 'validated' : 'rejected'}">
                <div class="hypothesis-title"><span>${h2 ? '‚úÖ' : '‚ùå'}</span><span>H2: March√© existant</span><span class="badge ${h2 ? 'badge-success' : 'badge-danger'}">${h2 ? 'VALID√âE' : 'NON'}</span></div>
                <div class="hypothesis-result">${h2p}% tr√®s int√©ress√©s</div>
                <div class="hypothesis-detail"><strong>Crit√®re:</strong> >40%<br><strong>Conclusion:</strong> ${h2 ? 'Valid√©' : 'Insuffisant'}</div>
            </div>`;
            
            html += `<div class="hypothesis-card ${h3 ? 'validated' : 'rejected'}">
                <div class="hypothesis-title"><span>${h3 ? '‚úÖ' : '‚ùå'}</span><span>H3: Pricing 10-20‚Ç¨</span><span class="badge ${h3 ? 'badge-success' : 'badge-danger'}">${h3 ? 'VALID√âE' : 'NON'}</span></div>
                <div class="hypothesis-result">${h3p}% acceptent</div>
                <div class="hypothesis-detail"><strong>Crit√®re:</strong> >30%<br><strong>Conclusion:</strong> ${h3 ? 'Valid√©' : 'Revoir prix'}</div>
            </div>`;
            
            html += `<div class="hypothesis-card ${h4 ? 'validated' : 'rejected'}">
                <div class="hypothesis-title"><span>${h4 ? '‚úÖ' : '‚ùå'}</span><span>H4: Intention forte</span><span class="badge ${h4 ? 'badge-success' : 'badge-danger'}">${h4 ? 'VALID√âE' : 'NON'}</span></div>
                <div class="hypothesis-result">${h4p}% certain</div>
                <div class="hypothesis-detail"><strong>Crit√®re:</strong> >15%<br><strong>Conclusion:</strong> ${h4 ? 'Valid√©' : 'Faible'}</div>
            </div>`;
            
            document.getElementById('hypothesesContainer').innerHTML = html;
            
            const count = [h1, h2, h3, h4].filter(Boolean).length;
            let insights = '<div class="insight-box"><h3>Synth√®se</h3>';
            if (count === 4) insights += '<p style="color:#28a745; font-weight:bold;">‚úÖ CONCEPT VALID√â (4/4)</p><p>D√©velopper le MVP!</p>';
            else if (count >= 2) insights += `<p style="color:#ffc107; font-weight:bold;">‚ö†Ô∏è PARTIEL (${count}/4)</p><p>Affiner.</p>`;
            else insights += `<p style="color:#dc3545; font-weight:bold;">‚ùå NON VALID√â (${count}/4)</p><p>Pivot n√©cessaire.</p>`;
            insights += '</div>';
            document.getElementById('businessInsights').innerHTML = insights;
        }
        
        function renderDetailedStats() {
            if (allResponses.length === 0) {
                document.getElementById('chartsContainer').innerHTML = '<p>Aucune donn√©e</p>';
                return;
            }
            const total = allResponses.length;
            let html = '';
            questions.forEach(q => {
                if (q.type === 'text') return;
                const data = {};
                allResponses.forEach(r => {
                    let answer = r[q.id];
                    if (q.type === 'scale' && typeof answer === 'number') answer = q.options[answer];
                    if (q.type === 'multiple') {
                        (answer || []).forEach(a => data[a] = (data[a] || 0) + 1);
                    } else {
                        answer = answer || 'Non renseign√©';
                        data[answer] = (data[answer] || 0) + 1;
                    }
                });
                html += `<div class="chart-section"><h3>${q.question}</h3>`;
                Object.entries(data).sort((a, b) => b[1] - a[1]).forEach(([answer, count]) => {
                    const percent = (count / total * 100).toFixed(0);
                    html += `<div class="chart-bar"><div class="chart-label"><span>${answer}</span><span><strong>${count}</strong> (${percent}%)</span></div><div class="bar-container"><div class="bar-fill" style="width:${percent}%">${percent}%</div></div></div>`;
                });
                html += '</div>';
            });
            document.getElementById('chartsContainer').innerHTML = html;
        }
        
        function renderSegmentation() {
            if (allResponses.length === 0) {
                document.getElementById('segmentationContainer').innerHTML = '<p>Aucune donn√©e</p>';
                return;
            }
            const segments = {};
            allResponses.forEach(r => {
                const p = r.profil || 'Non renseign√©';
                if (!segments[p]) segments[p] = { count: 0, highInt: 0, strongInt: 0 };
                segments[p].count++;
                if (r.interet === 'Tr√®s int√©ress√©(e)' || r.interet === 'Extr√™mement int√©ress√©(e)' || r.interet === 2 || r.interet === 3) segments[p].highInt++;
                if (r.utilisation === 'Oui, certainement') segments[p].strongInt++;
            });
            let html = '<h2>Segmentation</h2>';
            Object.entries(segments).forEach(([profil, data]) => {
                const intRate = (data.highInt / data.count * 100).toFixed(0);
                html += `<div class="insight-box"><h3>${profil} (${data.count})</h3><p>Int√©r√™t: ${intRate}%</p><p>${intRate >= 50 ? 'üéØ Prioritaire' : '‚ö™ Secondaire'}</p></div>`;
            });
            document.getElementById('segmentationContainer').innerHTML = html;
        }
        
        function exportCSV() {
            if (allResponses.length === 0) { alert('Aucune donn√©e'); return; }
            let csv = 'Date;' + questions.map(q => q.question.replace(/;/g, ',')).join(';') + '\n';
            allResponses.forEach(r => {
                csv += new Date(r.timestamp).toLocaleString('fr-FR') + ';';
                csv += questions.map(q => {
                    let answer = r[q.id];
                    if (q.type === 'scale' && typeof answer === 'number') answer = q.options[answer];
                    if (q.type === 'multiple') answer = (answer || []).join(' | ');
                    return (answer || '').toString().replace(/;/g, ',');
                }).join(';') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'reponses_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }
        
        function renderResponsesTable() {
            if (allResponses.length === 0) {
                document.getElementById('responsesTableContainer').innerHTML = '<p style="margin-top: 20px;">Aucune r√©ponse √† afficher</p>';
                return;
            }
            
            let html = `<p style="margin-top: 20px;"><strong>${allResponses.length} r√©ponse(s)</strong></p>`;
            html += '<table class="responses-table"><thead><tr>';
            html += '<th>Date</th><th>Profil</th><th>Situation</th><th>Int√©r√™t</th><th>Prix</th><th>Action</th>';
            html += '</tr></thead><tbody>';
            
            allResponses.forEach((r, idx) => {
                const date = new Date(r.timestamp).toLocaleString('fr-FR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const profil = r.profil || 'N/A';
                const situation = r.situation || 'N/A';
                let interet = r.interet;
                if (typeof interet === 'number') interet = questions[4].options[interet];
                interet = interet || 'N/A';
                const prix = r.prix || 'N/A';
                
                html += `<tr>
                    <td>${date}</td>
                    <td>${profil}</td>
                    <td>${situation}</td>
                    <td>${interet}</td>
                    <td>${prix}</td>
                    <td><button class="delete-btn" onclick="deleteResponse('${r.id}', ${idx})">Supprimer</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('responsesTableContainer').innerHTML = html;
        }
        
        async function deleteResponse(docId, index) {
            if (!confirm('Supprimer cette r√©ponse ?')) return;
            
            try {
                await window.deleteDoc(window.doc(window.db, 'responses', docId));
                allResponses.splice(index, 1);
                renderResponsesTable();
                alert('‚úÖ R√©ponse supprim√©e');
            } catch (error) {
                console.error('Erreur suppression:', error);
                alert('‚ùå Erreur lors de la suppression: ' + error.message);
            }
        }
    </script>
</body>
</html>
